<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventario - Inversiones Yegni-Maik</title>

  <style>
    :root {
      --azul: #0056a8;
      --azul-oscuro: #003b73;
      --naranja: #f26c21;
      --rojo: #e32026;
      --gris-claro: #f5f5f5;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, sans-serif;
    }

    body {
      background: #ffffff;
      color: #333;
      padding: 10px;
    }

    header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    header img {
      height: 60px;
    }

    header .title-block {
      display: flex;
      flex-direction: column;
    }

    header h1 {
      font-size: 18px;
      color: var(--azul-oscuro);
    }

    header span {
      font-size: 11px;
      color: #666;
    }

    .card {
      background: #ffffff;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    }

    .card h2 {
      font-size: 14px;
      margin-bottom: 10px;
      color: var(--azul-oscuro);
    }

    .tabs {
      display: flex;
      margin-bottom: 15px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--azul);
    }

    .tab-btn {
      flex: 1;
      padding: 12px;
      text-align: center;
      font-size: 13px;
      cursor: pointer;
      border: none;
      background: #ffffff;
      color: var(--azul-oscuro);
    }

    .tab-btn.active {
      background: var(--azul);
      color: #ffffff;
      font-weight: 600;
    }

    .tab-btn.egreso.active {
      background: var(--naranja);
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    label {
      font-size: 11px;
      color: #555;
      display: block;
      margin-bottom: 3px;
    }

    input, select {
      width: 100%;
      padding: 8px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--azul);
      box-shadow: 0 0 0 2px rgba(0, 86, 168, 0.1);
    }

    .btn {
      width: 100%;
      padding: 12px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      color: #ffffff;
    }

    .btn-ingreso { background: var(--azul); }
    .btn-egreso { background: var(--naranja); }
    .btn-borrar { background: var(--rojo); }

    .btn:hover { opacity: 0.9; }

    .search-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .search-row input { flex: 1; }
    .search-row select { min-width: 130px; }
    .search-row .btn { 
      flex: none; 
      width: auto; 
      padding: 10px 15px; 
      font-size: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      padding: 8px 6px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }

    th {
      background: var(--gris-claro);
      position: sticky;
      top: 0;
      z-index: 1;
      font-weight: 600;
    }

    .table-wrapper {
      max-height: 300px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid #eee;
      margin-top: 10px;
    }

    .stock-critico {
      color: var(--rojo);
      font-weight: 700;
      font-size: 14px;
    }

    .pill {
      padding: 3px 8px;
      border-radius: 20px;
      border: 1px solid;
      font-size: 10px;
      font-weight: 600;
    }

    .pill-alta {
      border-color: var(--rojo);
      color: var(--rojo);
      background: rgba(227, 32, 38, 0.1);
    }

    .pill-ok {
      border-color: var(--azul);
      color: var(--azul);
      background: rgba(0, 86, 168, 0.1);
    }

    .footer-note {
      margin-top: 10px;
      font-size: 11px;
      color: #777;
      line-height: 1.4;
    }

    @media (max-width: 600px) {
      .form-grid { grid-template-columns: 1fr; }
      .search-row { flex-direction: column; }
      th:nth-child(5), td:nth-child(5),
      th:nth-child(6), td:nth-child(6),
      th:nth-child(7), td:nth-child(7) { display: none; }
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo Yegni-Maik" />
    <div class="title-block">
      <h1>Inversiones Yegni-Maik</h1>
      <span>Sistema de Inventario - Almac√©n</span>
    </div>
  </header>

  <!-- FORMULARIO MOVIMIENTOS -->
  <section class="card">
    <h2>üì¶ Movimiento de Inventario</h2>

    <div class="tabs">
      <button class="tab-btn active" id="tabIngreso">‚ûï Ingreso</button>
      <button class="tab-btn egreso" id="tabEgreso">‚ûñ Egreso</button>
    </div>

    <form id="formMovimiento">
      <input type="hidden" id="tipoMovimiento" value="INGRESO" />

      <div class="form-grid">
        <div>
          <label>Producto *</label>
          <input type="text" id="nombreProducto" placeholder="Harina Pan 900g" required />
        </div>

        <div>
          <label>Categor√≠a *</label>
          <select id="categoria" required>
            <option value="">Seleccione...</option>
            <option value="aseo e higiene">üßº Aseo e higiene</option>
            <option value="jugueteria">üß∏ Jugueter√≠a</option>
            <option value="bebidas alcoholicas">üç∫ Bebidas alcoh√≥licas</option>
            <option value="accesorios">üíç Accesorios</option>
            <option value="papeleria">üìù Papeler√≠a</option>
            <option value="alimentos">ü•õ Alimentos</option>
            <option value="embutidos">ü•ì Embutidos</option>
            <option value="golosinas y dulces">üç≠ Golosinas y dulces</option>
            <option value="bazar">üè™ Bazar</option>
            <option value="utensilios b√°sicos">üçΩÔ∏è Utensilios b√°sicos</option>
            <option value="productos para bebe">üçº Productos para beb√©</option>
            <option value="ferreter√≠a">üîß Ferreter√≠a</option>
          </select>
        </div>

        <div>
          <label>Cantidad *</label>
          <input type="number" id="cantidad" min="1" step="1" placeholder="10" required />
        </div>

        <div>
          <label>Precio unitario (USD)</label>
          <input type="number" id="precioUnitario" min="0" step="0.01" placeholder="1.20" />
        </div>

        <div>
          <label>Responsable *</label>
          <input type="text" id="responsable" placeholder="Juan P√©rez" required />
        </div>

        <div>
          <label>Caracter√≠sticas</label>
          <input type="text" id="caracteristicas" placeholder="Marca Lis, 900g" />
        </div>
      </div>

      <button type="submit" class="btn btn-ingreso" id="btnGuardar">
        ‚ûï Registrar Ingreso
      </button>
    </form>

    <p class="footer-note">
      üí° En egresos el precio se calcula autom√°ticamente del √∫ltimo ingreso
    </p>
  </section>

  <!-- INVENTARIO ACTUAL -->
  <section class="card">
    <h2>üìä Inventario Actual</h2>

    <div class="search-row">
      <input type="text" id="busquedaNombre" placeholder="üîç Buscar producto..." />
      <select id="busquedaCategoria">
        <option value="">Todas categor√≠as</option>
        <option value="aseo e higiene">üßº Aseo</option>
        <option value="jugueteria">üß∏ Jugueter√≠a</option>
        <option value="bebidas alcoholicas">üç∫ Bebidas</option>
        <option value="accesorios">üíç Accesorios</option>
        <option value="papeleria">üìù Papeler√≠a</option>
        <option value="alimentos">ü•õ Alimentos</option>
        <option value="embutidos">ü•ì Embutidos</option>
        <option value="golosinas y dulces">üç≠ Golosinas</option>
        <option value="bazar">üè™ Bazar</option>
        <option value="utensilios b√°sicos">üçΩÔ∏è Utensilios</option>
        <option value="productos para bebe">üçº Beb√©</option>
        <option value="ferreter√≠a">üîß Ferreter√≠a</option>
      </select>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Producto</th>
            <th>Categor√≠a</th>
            <th>Stock</th>
            <th>Estado</th>
            <th>Ingresos</th>
            <th>Egresos</th>
            <th>Responsables</th>
          </tr>
        </thead>
        <tbody id="tablaInventario">
          <tr><td colspan="7" style="text-align:center;padding:20px;color:#999">No hay productos registrados a√∫n</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- REPORTES -->
  <section class="card">
    <h2>üìà Reportes y Gesti√≥n</h2>
    
    <div class="search-row">
      <button class="btn btn-egreso" id="btnReporte">üìã Ver movimientos</button>
      <button class="btn btn-borrar" id="btnBorrarHistorial">üóëÔ∏è Borrar historial</button>
      <button class="btn" style="background:#0056a8;color:#fff" id="btnExportar">üìß Exportar correo</button>
    </div>

    <div class="table-wrapper" id="reporteWrapper" style="display: none">
      <table>
        <thead>
          <tr>
            <th>Fecha/Hora</th>
            <th>Tipo</th>
            <th>Producto</th>
            <th>Cant.</th>
            <th>USD</th>
            <th>Categor√≠a</th>
            <th>Responsable</th>
          </tr>
        </thead>
        <tbody id="tablaReporte"></tbody>
      </table>
    </div>

    <p class="footer-note">
      üìß Los reportes se env√≠an a jhoncuenta2@gmail.com | üóëÔ∏è Borrar historial elimina TODO
    </p>
  </section>

  <script>
    const STORAGE_KEY = "yegni_maik_inventario_v1";
    let movimientos = [];

    function hoyISO() {
      return new Date().toISOString().slice(0, 10);
    }

    function cargarDatos() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) {
          movimientos = JSON.parse(data);
        } else {
          movimientos = [];
        }
      } catch (e) {
        movimientos = [];
      }
      guardarDatos();
    }

    function guardarDatos() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(movimientos));
    }

    function formatearFechaHora(fecha) {
      const d = new Date(fecha);
      return d.toLocaleString("es-VE", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
      });
    }

    function calcularInventario() {
      const inventario = {};
      const responsablesPorProducto = {};
      const conteoIngresos = {};
      const conteoEgresos = {};

      movimientos.forEach(m => {
        const key = m.nombre.toLowerCase();
        
        if (!inventario[key]) {
          inventario[key] = {
            nombre: m.nombre,
            categoria: m.categoria,
            stock: 0,
            ultimoPrecio: 0
          };
          responsablesPorProducto[key] = new Set();
          conteoIngresos[key] = 0;
          conteoEgresos[key] = 0;
        }

        if (m.tipo === "INGRESO") {
          inventario[key].stock += m.cantidad;
          inventario[key].ultimoPrecio = m.precioUnitario;
          conteoIngresos[key]++;
        } else {
          inventario[key].stock -= m.cantidad;
          conteoEgresos[key]++;
        }
        
        if (m.responsable) {
          responsablesPorProducto[key].add(m.responsable);
        }
      });

      return {
        inventario,
        responsablesPorProducto,
        conteoIngresos,
        conteoEgresos
      };
    }

    function mostrarInventario() {
      const tbody = document.getElementById("tablaInventario");
      const filtroNombre = document.getElementById("busquedaNombre").value.toLowerCase();
      const filtroCat = document.getElementById("busquedaCategoria").value;

      const { inventario, responsablesPorProducto, conteoIngresos, conteoEgresos } = calcularInventario();

      tbody.innerHTML = "";

      if (Object.keys(inventario).length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;color:#999">No hay productos registrados a√∫n</td></tr>';
        return;
      }

      Object.keys(inventario)
        .sort()
        .forEach(key => {
          const item = inventario[key];
          
          if (filtroNombre && !item.nombre.toLowerCase().includes(filtroNombre)) return;
          if (filtroCat && item.categoria !== filtroCat) return;

          const responsables = Array.from(responsablesPorProducto[key] || []).join(", ");
          const esCritico = item.stock < 10;
          const estado = esCritico 
            ? '<span class="pill pill-alta">‚ö†Ô∏è ALERTA <10</span>'
            : '<span class="pill pill-ok">‚úÖ Stock OK</span>';

          const fila = document.createElement("tr");
          fila.innerHTML = `
            <td>${item.nombre}</td>
            <td>${item.categoria}</td>
            <td class="${esCritico ? 'stock-critico' : ''}">${item.stock}</td>
            <td>${estado}</td>
            <td>${conteoIngresos[key] || 0}</td>
            <td>${conteoEgresos[key] || 0}</td>
            <td style="font-size:10px">${responsables || '-'}</td>
          `;
          tbody.appendChild(fila);
        });
    }

    function mostrarReporte() {
      const tbody = document.getElementById("tablaReporte");
      tbody.innerHTML = "";

      const movimientosOrdenados = [...movimientos]
        .sort((a, b) => new Date(b.fechaHora) - new Date(a.fechaHora));

      if (movimientosOrdenados.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;color:#999">No hay movimientos</td></tr>';
        return;
      }

      movimientosOrdenados.slice(0, 50).forEach(m => {
        const badge = m.tipo === "INGRESO" 
          ? '<span class="badge" style="background:var(--azul)">+IN</span>'
          : '<span class="badge" style="background:var(--naranja)">-EG</span>';
        
        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td>${formatearFechaHora(m.fechaHora)}</td>
          <td>${badge}</td>
          <td>${m.nombre}</td>
          <td>${m.cantidad}</td>
          <td>$${m.totalUSD.toFixed(2)}</td>
          <td>${m.categoria}</td>
          <td>${m.responsable}</td>
        `;
        tbody.appendChild(fila);
      });
    }

    function borrarHistorial() {
      if (confirm("üóëÔ∏è ¬øBorrar TODO el historial?

Esto eliminar√° TODOS los movimientos y el inventario quedar√° en CERO.")) {
        movimientos = [];
        guardarDatos();
        mostrarInventario();
        mostrarReporte();
        alert("‚úÖ Historial borrado completamente");
      }
    }

    function exportarCorreo() {
      let texto = "üì¶ REPORTE INVENTARIO YEGNI-MAIK

";
      texto += `Fecha: ${new Date().toLocaleDateString("es-VE")}

`;
      
      texto += "MOVIMIENTOS RECIENTES:
" + "‚îÄ".repeat(40) + "
";
      movimientos.slice(-15).reverse().forEach(m => {
        texto += `${formatearFechaHora(m.fechaHora)} | ${m.tipo} | ${m.nombre} | ${m.cantidad}un | $${m.totalUSD.toFixed(2)} | ${m.responsable}
`;
      });

      texto += "
INVENTARIO ACTUAL:
" + "‚îÄ".repeat(40) + "
";
      const { inventario } = calcularInventario();
      Object.entries(inventario).forEach(([key, item]) => {
        texto += `${item.nombre}: ${item.stock} (${item.categoria})
`;
      });

      const email = "jhoncuenta2@gmail.com";
      const asunto = `Reporte Inventario ${hoyISO()}`;
      window.location.href = `mailto:${email}?subject=${encodeURIComponent(asunto)}&body=${encodeURIComponent(texto)}`;
    }

    function registrarMovimiento(e) {
      e.preventDefault();

      const tipo = document.getElementById("tipoMovimiento").value;
      const nombre = document.getElementById("nombreProducto").value.trim().toUpperCase();
      const categoria = document.getElementById("categoria").value;
      const cantidad = parseInt(document.getElementById("cantidad").value);
      const responsable = document.getElementById("responsable").value.trim();
      const precioInput = parseFloat(document.getElementById("precioUnitario").value);

      // VALIDACIONES
      if (!nombre || !categoria || !cantidad || !responsable) {
        alert("‚ùå Complete TODOS los campos obligatorios (*)");
        return;
      }

      let precioUnitario;
      if (tipo === "EGRESO") {
        const { inventario } = calcularInventario();
        const itemExistente = inventario[nombre.toLowerCase()];
        if (!itemExistente || itemExistente.stock < cantidad) {
          alert(`‚ùå Stock insuficiente. ${nombre} tiene ${itemExistente?.stock || 0} unidades`);
          return;
        }
        precioUnitario = itemExistente.ultimoPrecio || 0;
      } else {
        if (!precioInput || precioInput <= 0) {
          alert("‚ùå Ingrese precio unitario v√°lido para INGRESOS");
          return;
        }
        precioUnitario = precioInput;
      }

      // CREAR MOVIMIENTO
      const movimiento = {
        id: Date.now(),
        tipo,
        nombre,
        categoria,
        cantidad,
        precioUnitario,
        totalUSD: precioUnitario * cantidad,
        responsable,
        fechaHora: new Date().toISOString()
      };

      // GUARDAR
      movimientos.push(movimiento);
      guardarDatos();
      
      // LIMPIAR FORMULARIO
      document.getElementById("formMovimiento").reset();
      document.getElementById("categoria").value = "";
      
      // ACTUALIZAR VISTAS
      mostrarInventario();
      
      alert(`‚úÖ ${tipo} registrado: ${nombre} x${cantidad}`);
    }

    // EVENTOS
    function configurarEventos() {
      // Tabs
      document.getElementById("tabIngreso").onclick = () => {
        document.getElementById("tabIngreso").classList.add("active");
        document.getElementById("tabEgreso").classList.remove("active");
        document.getElementById("tipoMovimiento").value = "INGRESO";
        document.getElementById("btnGuardar").textContent = "‚ûï Registrar Ingreso";
        document.getElementById("btnGuardar").className = "btn btn-ingreso";
        document.getElementById("precioUnitario").disabled = false;
      };

      document.getElementById("tabEgreso").onclick = () => {
        document.getElementById("tabEgreso").classList.add("active");
        document.getElementById("tabIngreso").classList.remove("active");
        document.getElementById("tipoMovimiento").value = "EGRESO";
        document.getElementById("btnGuardar").textContent = "‚ûñ Registrar Egreso";
        document.getElementById("btnGuardar").className = "btn btn-egreso";
        document.getElementById("precioUnitario").disabled = true;
      };

      // Botones reporte
      document.getElementById("btnReporte").onclick = () => {
        const wrapper = document.getElementById("reporteWrapper");
        wrapper.style.display = wrapper.style.display === "block" ? "none" : "block";
        if (wrapper.style.display === "block") mostrarReporte();
      };

      document.getElementById("btnBorrarHistorial").onclick = borrarHistorial;
      document.getElementById("btnExportar").onclick = exportarCorreo;

      // Filtros
      document.getElementById("busquedaNombre").oninput = mostrarInventario;
      document.getElementById("busquedaCategoria").onchange = mostrarInventario;

      // Formulario
      document.getElementById("formMovimiento").onsubmit = registrarMovimiento;
    }

    // INICIO
    document.addEventListener("DOMContentLoaded", () => {
      cargarDatos();
      configurarEventos();
      mostrarInventario();
    });
  </script>
</body>
</html>
