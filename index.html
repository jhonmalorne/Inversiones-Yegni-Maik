<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventario - Inversiones Yegni-Maik</title>

  <!-- Estilos internos -->
  <style>
    :root {
      --azul: #0056a8;
      --azul-oscuro: #003b73;
      --naranja: #f26c21;
      --rojo: #e32026;
      --amarillo: #f7b500;
      --gris-claro: #f5f5f5;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      background: #ffffff;
      color: #333;
      padding: 10px;
    }

    header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    header img {
      height: 60px;
    }

    header .title-block {
      display: flex;
      flex-direction: column;
    }

    header h1 {
      font-size: 18px;
      color: var(--azul-oscuro);
    }

    header span {
      font-size: 11px;
      color: #666;
    }

    .card {
      background: #ffffff;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    }

    .card h2 {
      font-size: 14px;
      margin-bottom: 6px;
      color: var(--azul-oscuro);
    }

    .tabs {
      display: flex;
      margin-bottom: 10px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--azul);
    }

    .tab-btn {
      flex: 1;
      padding: 8px;
      text-align: center;
      font-size: 13px;
      cursor: pointer;
      border: none;
      background: #ffffff;
      color: var(--azul-oscuro);
    }

    .tab-btn.active {
      background: var(--azul);
      color: #ffffff;
      font-weight: 600;
    }

    .tab-btn.egreso.active {
      background: var(--naranja);
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 6px;
    }

    .form-grid.full {
      grid-template-columns: 1fr;
    }

    label {
      font-size: 11px;
      color: #555;
      display: block;
      margin-bottom: 2px;
    }

    input,
    select {
      width: 100%;
      padding: 7px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--azul);
      box-shadow: 0 0 0 1px rgba(0, 86, 168, 0.1);
    }

    .btn {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 6px;
      color: #ffffff;
    }

    .btn-ingreso {
      background: var(--azul);
    }

    .btn-egreso {
      background: var(--naranja);
    }

    .btn-borrar {
      background: var(--rojo);
    }

    .btn:hover {
      opacity: 0.9;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      color: #ffffff;
    }

    .badge-ingreso {
      background: var(--azul);
    }

    .badge-egreso {
      background: var(--naranja);
    }

    .badge-critico {
      background: var(--rojo);
    }

    .search-row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .search-row input {
      flex: 1;
    }

    .search-row select {
      min-width: 120px;
    }

    .search-row .btn {
      flex: none;
      width: auto;
      padding: 8px 12px;
      font-size: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 11px;
    }

    th,
    td {
      padding: 6px 4px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }

    th {
      background: var(--gris-claro);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .table-wrapper {
      max-height: 260px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid #eee;
      margin-top: 6px;
    }

    .stock-critico {
      color: var(--rojo);
      font-weight: 700;
    }

    .pill {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #ddd;
      font-size: 10px;
      background: #fff;
    }

    .pill-alta {
      border-color: var(--rojo);
      color: var(--rojo);
    }

    .pill-ok {
      border-color: var(--azul);
      color: var(--azul);
    }

    .footer-note {
      margin-top: 8px;
      font-size: 10px;
      color: #777;
    }

    .contador-dias {
      background: var(--amarillo);
      color: var(--azul-oscuro);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      margin-top: 6px;
    }

    @media (max-width: 600px) {
      header h1 {
        font-size: 16px;
      }
      .form-grid {
        grid-template-columns: 1fr;
      }
      th:nth-child(5),
      td:nth-child(5),
      th:nth-child(6),
      td:nth-child(6),
      th:nth-child(7),
      td:nth-child(7) {
        display: none;
      }
      .search-row {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo Inversiones Yegni-Maik" />
    <div class="title-block">
      <h1>Inversiones Yegni-Maik</h1>
      <span>Sistema interno de inventario de almacén</span>
    </div>
  </header>

  <!-- Formulario de movimiento -->
  <section class="card">
    <h2>Movimiento de inventario</h2>

    <div class="tabs">
      <button class="tab-btn active" id="tabIngreso">Ingreso</button>
      <button class="tab-btn egreso" id="tabEgreso">Egreso</button>
    </div>

    <form id="formMovimiento">
      <input type="hidden" id="tipoMovimiento" value="INGRESO" />

      <div class="form-grid">
        <div>
          <label for="nombreProducto">Producto</label>
          <input
            type="text"
            id="nombreProducto"
            placeholder="Nombre del producto"
            required
          />
        </div>

        <div>
          <label for="categoria">Categoría</label>
          <select id="categoria" required>
            <option value="">Seleccione</option>
            <option value="aseo e higiene">Aseo e higiene</option>
            <option value="jugueteria">Juguetería</option>
            <option value="bebidas alcoholicas">Bebidas alcohólicas</option>
            <option value="accesorios">Accesorios</option>
            <option value="papeleria">Papelería</option>
            <option value="alimentos">Alimentos</option>
            <option value="embutidos">Embutidos</option>
            <option value="golosinas y dulces">Golosinas y dulces</option>
            <option value="bazar">Bazar</option>
            <option value="utensilios básicos">Utensilios básicos</option>
            <option value="productos para bebe">Productos para bebé</option>
            <option value="ferretería">Ferretería</option>
          </select>
        </div>

        <div>
          <label for="cantidad">Cantidad</label>
          <input
            type="number"
            id="cantidad"
            min="1"
            step="1"
            placeholder="Unidades"
            required
          />
        </div>

        <div>
          <label for="precioUnitario">Precio unitario (USD)</label>
          <input
            type="number"
            id="precioUnitario"
            min="0"
            step="0.01"
            placeholder="Solo para ingreso"
          />
        </div>

        <div>
          <label for="responsable">Responsable</label>
          <input
            type="text"
            id="responsable"
            placeholder="Nombre y apellido"
            required
          />
        </div>

        <div>
          <label for="caracteristicas">Características</label>
          <input
            type="text"
            id="caracteristicas"
            placeholder="Marca, presentación, detalle"
          />
        </div>
      </div>

      <button type="submit" class="btn btn-ingreso" id="btnGuardar">
        Registrar ingreso
      </button>
    </form>

    <p class="footer-note">
      Los montos en dólares se calculan automáticamente en los egresos según el
      precio unitario registrado en el último ingreso del producto.
    </p>
  </section>

  <!-- Resumen y búsqueda -->
  <section class="card">
    <h2>Inventario y búsqueda</h2>

    <div class="search-row">
      <input
        type="text"
        id="busquedaNombre"
        placeholder="Buscar producto por nombre"
      />
      <select id="busquedaCategoria">
        <option value="">Todas las categorías</option>
        <option value="aseo e higiene">Aseo e higiene</option>
        <option value="jugueteria">Juguetería</option>
        <option value="bebidas alcoholicas">Bebidas alcohólicas</option>
        <option value="accesorios">Accesorios</option>
        <option value="papeleria">Papelería</option>
        <option value="alimentos">Alimentos</option>
        <option value="embutidos">Embutidos</option>
        <option value="golosinas y dulces">Golosinas y dulces</option>
        <option value="bazar">Bazar</option>
        <option value="utensilios básicos">Utensilios básicos</option>
        <option value="productos para bebe">Productos para bebé</option>
        <option value="ferretería">Ferretería</option>
      </select>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Producto</th>
            <th>Categoría</th>
            <th>Stock</th>
            <th>Estado</th>
            <th>Ingresos</th>
            <th>Egresos</th>
            <th>Responsables</th>
          </tr>
        </thead>
        <tbody id="tablaInventario"></tbody>
      </table>
    </div>
  </section>

  <!-- Reporte diario -->
  <section class="card">
    <h2>Reporte diario</h2>
    
    <div class="search-row">
      <button class="btn btn-egreso" id="btnReporte">Ver reporte de hoy</button>
      <button class="btn btn-borrar" id="btnBorrarHistorial">Borrar historial</button>
      <button class="btn" style="background:#0056a8;color:#fff" id="btnExportar">
        Exportar por correo
      </button>
    </div>

    <div class="contador-dias" id="contadorDias">
      Cargando contador de días...
    </div>

    <div class="table-wrapper" id="reporteWrapper" style="display: none">
      <table>
        <thead>
          <tr>
            <th>Fecha / Hora</th>
            <th>Tipo</th>
            <th>Producto</th>
            <th>Cant.</th>
            <th>USD</th>
            <th>Categoría</th>
            <th>Responsable</th>
          </tr>
        </thead>
        <tbody id="tablaReporte"></tbody>
      </table>
    </div>

    <p class="footer-note">
      El reporte muestra solo los movimientos del día actual. Se reinicia
      automáticamente cada 24 horas. Historial se limpia cada 31 días.
    </p>
  </section>

  <script>
    const STORAGE_KEY = "yegni_maik_inventario_v1";

    const state = {
      movimientos: [],
      fechaDia: "",
      fechaInicio: ""
    };

    function hoyISO() {
      const hoy = new Date();
      return hoy.toISOString().slice(0, 10);
    }

    function diasEntre(fechainicio, fechaFin) {
      const inicio = new Date(fechainicio);
      const fin = new Date(fechaFin);
      const diffTime = Math.abs(fin - inicio);
      return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }

    function cargarDesdeStorage() {
      const raw = localStorage.getItem(STORAGE_KEY);
      const hoy = hoyISO();
      
      if (!raw) {
        state.movimientos = [];
        state.fechaDia = hoy;
        state.fechaInicio = hoy;
        guardarEnStorage();
        actualizarContadorDias();
        return;
      }

      try {
        const data = JSON.parse(raw);
        state.fechaDia = data.fechaDia || hoy;
        state.fechaInicio = data.fechaInicio || hoy;

        // Verificar si pasaron 31 días desde el inicio
        const diasPasados = diasEntre(state.fechaInicio, hoy);
        
        if (diasPasados >= 31) {
          borrarSoloHistorialAuto();
          return;
        }

        if (state.fechaDia !== hoy) {
          // Solo reset diario
          state.fechaDia = hoy;
          guardarEnStorage();
        } else {
          state.movimientos = Array.isArray(data.movimientos) ? data.movimientos : [];
        }
        
        actualizarContadorDias();
      } catch (e) {
        state.movimientos = [];
        state.fechaDia = hoy;
        state.fechaInicio = hoy;
        guardarEnStorage();
        actualizarContadorDias();
      }
    }

    function guardarEnStorage() {
      localStorage.setItem(
        STORAGE_KEY,
        JSON.stringify({
          fechaDia: state.fechaDia,
          fechaInicio: state.fechaInicio,
          movimientos: state.movimientos
        })
      );
    }

    function actualizarContadorDias() {
      const dias = diasEntre(state.fechaInicio, hoyISO());
      document.getElementById("contadorDias").textContent = 
        `Días de uso: ${dias}/31`;
    }

    function formatearFechaHora(fecha) {
      const d = new Date(fecha);
      const dia = d.toLocaleDateString("es-VE");
      const hora = d.toLocaleTimeString("es-VE", {
        hour: "2-digit",
        minute: "2-digit",
      });
      return `${dia} ${hora}`;
    }

    function construirInventario() {
      const inventario = {};
      const responsablesPorProducto = {};
      const conteoIngresos = {};
      const conteoEgresos = {};

      state.movimientos.forEach((m) => {
        const key = m.nombre.toLowerCase();
        if (!inventario[key]) {
          inventario[key] = {
            nombre: m.nombre,
            categoria: m.categoria,
            stock: 0,
            ultimoPrecio: 0,
          };
          responsablesPorProducto[key] = new Set();
          conteoIngresos[key] = 0;
          conteoEgresos[key] = 0;
        }

        if (m.tipo === "INGRESO") {
          inventario[key].stock += m.cantidad;
          inventario[key].ultimoPrecio = m.precioUnitario;
          conteoIngresos[key] += 1;
        } else {
          inventario[key].stock -= m.cantidad;
          conteoEgresos[key] += 1;
        }
        if (m.responsable) responsablesPorProducto[key].add(m.responsable);
      });

      return {
        inventario,
        responsablesPorProducto,
        conteoIngresos,
        conteoEgresos,
      };
    }

    function renderInventario() {
      const tbody = document.getElementById("tablaInventario");
      tbody.innerHTML = "";

      const filtroNombre = document
        .getElementById("busquedaNombre")
        .value.toLowerCase();
      const filtroCat = document.getElementById("busquedaCategoria").value;

      const {
        inventario,
        responsablesPorProducto,
        conteoIngresos,
        conteoEgresos,
      } = construirInventario();

      Object.keys(inventario)
        .sort()
        .forEach((key) => {
          const item = inventario[key];

          if (
            filtroNombre &&
            !item.nombre.toLowerCase().includes(filtroNombre)
          ) {
            return;
          }
          if (filtroCat && item.categoria !== filtroCat) {
            return;
          }

          const responsables = Array.from(
            responsablesPorProducto[key] || []
          ).join(", ");

          const tr = document.createElement("tr");

          const esCritico = item.stock < 10;

          const estadoHTML = esCritico
            ? '<span class="pill pill-alta">Alerta &lt; 10</span>'
            : '<span class="pill pill-ok">Stock ok</span>';

          tr.innerHTML = `
            <td>${item.nombre}</td>
            <td>${item.categoria}</td>
            <td class="${esCritico ? "stock-critico" : ""}">${item.stock}</td>
            <td>${estadoHTML}</td>
            <td>${conteoIngresos[key] || 0}</td>
            <td>${conteoEgresos[key] || 0}</td>
            <td>${responsables || "-"}</td>
          `;

          tbody.appendChild(tr);
        });
    }

    function renderReporte() {
      const tbody = document.getElementById("tablaReporte");
      tbody.innerHTML = "";

      const movimientosOrdenados = [...state.movimientos].sort(
        (a, b) => new Date(b.fechaHora) - new Date(a.fechaHora)
      );

      movimientosOrdenados.forEach((m) => {
        const tr = document.createElement("tr");
        const badge =
          m.tipo === "INGRESO"
            ? '<span class="badge badge-ingreso">Ingreso</span>'
            : '<span class="badge badge-egreso">Egreso</span>';
        tr.innerHTML = `
          <td>${formatearFechaHora(m.fechaHora)}</td>
          <td>${badge}</td>
          <td>${m.nombre}</td>
          <td>${m.cantidad}</td>
          <td>${m.totalUSD.toFixed(2)}</td>
          <td>${m.categoria}</td>
          <td>${m.responsable || "-"}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function borrarSoloHistorial(motivo = "MANUAL") {
      if (!confirm(`¿Seguro que desea borrar TODO el historial de movimientos?

El stock actual se recalculará como ajuste de sistema (${motivo}).`)) {
        return false;
      }

      const { inventario } = construirInventario();
      const nuevaFecha = new Date().toISOString();

      const nuevosMovimientos = [];
      Object.keys(inventario).forEach(key => {
        const item = inventario[key];
        if (item.stock > 0) {
          nuevosMovimientos.push({
            id: Date.now() + Math.random(),
            tipo: "INGRESO",
            nombre: item.nombre,
            categoria: item.categoria,
            cantidad: item.stock,
            precioUnitario: item.ultimoPrecio || 0,
            totalUSD: (item.ultimoPrecio || 0) * item.stock,
            responsable: `AJUSTE SISTEMA ${motivo}`,
            caracteristicas: `Ajuste de stock al ${motivo.toLowerCase()}`,
            fechaHora: nuevaFecha
          });
        }
      });

      state.movimientos = nuevosMovimientos;
      state.fechaDia = hoyISO();
      if (motivo === "AUTO") {
        state.fechaInicio = hoyISO(); // reinicia contador 31 días
      }
      guardarEnStorage();
      actualizarContadorDias();
      renderInventario();
      renderReporte();
      return true;
    }

    function borrarSoloHistorialAuto() {
      borrarSoloHistorial("AUTO");
    }

    function generarTextoReporte() {
      let texto = "=== REPORTE DE INVENTARIO YEGNI-MAIK ===

";
      texto += `Fecha: ${new Date().toLocaleDateString("es-VE")}
`;
      texto += `Días de uso del sistema: ${diasEntre(state.fechaInicio, hoyISO())}

`;
      
      texto += "ÚLTIMOS MOVIMIENTOS:
";
      texto += "-".repeat(50) + "
";
      
      const ultimos = state.movimientos.slice(-20).reverse();
      ultimos.forEach(m => {
        texto += `${formatearFechaHora(m.fechaHora)} | ${m.tipo} | ${m.nombre} | Cant: ${m.cantidad} | USD: $${m.totalUSD.toFixed(2)} | ${m.responsable}
`;
      });
      
      texto += "
" + "-".repeat(50) + "
";
      texto += "INVENTARIO ACTUAL:
";
      
      const { inventario } = construirInventario();
      Object.keys(inventario).sort().forEach(key => {
        const item = inventario[key];
        texto += `${item.nombre}: ${item.stock} und (${item.categoria})
`;
      });
      
      return texto;
    }

    function exportarPorCorreo() {
      const email = "jhoncuenta2@gmail.com";
      const subject = `Reporte Inventario Yegni-Maik ${hoyISO()}`;
      const body = generarTextoReporte();
      const link = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.location.href = link;
    }

    function registrarMovimiento(e) {
      e.preventDefault();

      const tipo = document.getElementById("tipoMovimiento").value;
      const nombre = document
        .getElementById("nombreProducto")
        .value.trim()
        .toUpperCase();
      const categoria = document.getElementById("categoria").value;
      const cantidad = parseInt(
        document.getElementById("cantidad").value,
        10
      );
      const responsable = document
        .getElementById("responsable")
        .value.trim();
      const caracteristicas = document
        .getElementById("caracteristicas")
        .value.trim();

      if (!nombre || !categoria || !cantidad || !responsable) {
        alert("Complete todos los campos obligatorios");
        return;
      }

      let precioUnitario = parseFloat(
        document.getElementById("precioUnitario").value
      );
      
      if (tipo === "EGRESO") {
        const { inventario } = construirInventario();
        const key = nombre.toLowerCase();
        const item = inventario[key];
        if (!item || item.stock < cantidad) {
          alert(
            "❌ No hay stock suficiente o el producto no tiene ingresos registrados."
          );
          return;
        }
        precioUnitario = item.ultimoPrecio || 0;
      } else {
        if (isNaN(precioUnitario) || precioUnitario <= 0) {
          alert("❌ Ingrese precio unitario válido para ingresos");
          return;
        }
      }

      const totalUSD = precioUnitario * cantidad;

      const movimiento = {
        id: Date.now(),
        tipo,
        nombre,
        categoria,
        cantidad,
        precioUnitario,
        totalUSD,
        responsable,
        caracteristicas,
        fechaHora: new Date().toISOString(),
      };

      state.movimientos.push(movimiento);
      guardarEnStorage();
      renderInventario();
      actualizarContadorDias();

      document.getElementById("formMovimiento").reset();
      document.getElementById("categoria").value = "";
      if (tipo === "INGRESO") {
        document.getElementById("precioUnitario").value = "";
      }

      alert("✅ Movimiento registrado correctamente");
    }

    function configurarTabs() {
      const tabIngreso = document.getElementById("tabIngreso");
      const tabEgreso = document.getElementById("tabEgreso");
      const tipoInput = document.getElementById("tipoMovimiento");
      const btnGuardar = document.getElementById("btnGuardar");
      const precioInput = document.getElementById("precioUnitario");

      tabIngreso.addEventListener("click", () => {
        tabIngreso.classList.add("active");
        tabEgreso.classList.remove("active");
        tipoInput.value = "INGRESO";
        btnGuardar.textContent = "Registrar ingreso";
        btnGuardar.classList.remove("btn-egreso");
        btnGuardar.classList.add("btn-ingreso");
        precioInput.disabled = false;
        precioInput.placeholder = "Precio unitario (USD)";
        precioInput.required = true;
      });

      tabEgreso.addEventListener("click", () => {
        tabEgreso.classList.add("active");
        tabIngreso.classList.remove("active");
        tipoInput.value = "EGRESO";
        btnGuardar.textContent = "Registrar egreso";
        btnGuardar.classList.remove("btn-ingreso");
        btnGuardar.classList.add("btn-egreso");
        precioInput.disabled = true;
        precioInput.placeholder = "Se usa el último precio registrado";
        precioInput.required = false;
      });
    }

    function configurarBusqueda() {
      document
        .getElementById("busquedaNombre")
        .addEventListener("input", renderInventario);
      document
        .getElementById("busquedaCategoria")
        .addEventListener("change", renderInventario);
    }

    function configurarReporte() {
      const btnReporte = document.getElementById("btnReporte");
      const wrapper = document.getElementById("reporteWrapper");
      
      btnReporte.addEventListener("click", () => {
        const visible = wrapper.style.display === "block";
        wrapper.style.display = visible ? "none" : "block";
        if (!visible) {
          renderReporte();
        }
      });

      document.getElementById("btnBorrarHistorial")
        .addEventListener("click", () => borrarSoloHistorial("MANUAL"));

      document.getElementById("btnExportar")
        .addEventListener("click", exportarPorCorreo);
    }

    document.addEventListener("DOMContentLoaded", () => {
      cargarDesdeStorage();
      configurarTabs();
      configurarBusqueda();
      configurarReporte();
      document
        .getElementById("formMovimiento")
        .addEventListener("submit", registrarMovimiento);
      renderInventario();
    });
  </script>
</body>
</html>
